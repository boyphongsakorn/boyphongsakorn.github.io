<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWisetthon</title>
    <meta name="google-adsense-account" content="ca-pub-9734327609923498">
    <script defer src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-2 text-gray-800">PWisetthon</h1>
        <p class="text-gray-600 mb-6">‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡∏ó‡∏≥‡∏•‡∏∞‡πÄ‡∏ß‡πá‡∏ö ‡∏Å‡∏î‡∏ï‡∏≤‡∏° ul list ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏•‡∏∞‡∏Å‡∏±‡∏ô</p>
        
        <ul class="space-y-3">
            <li id="twitchbanneralert" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <!-- Left box: Alert banner -->
                    <a href="https://www.twitch.tv/boyalone99" target="_blank" rel="noopener noreferrer" class="flex items-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200 md:col-span-2">
                        <img class="w-10 h-10 rounded-full mr-2" src="https://upload.wikimedia.org/wikipedia/commons/4/41/Red_circle.gif" alt="Live indicator">
                        <span class="text-blue-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏•‡∏ü‡πå ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô Twitch - ‡∏î‡∏π‡πÄ‡∏•‡∏¢!</span>
                    </a>
                    <!-- Right box: Preview image card -->
                    <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 overflow-hidden h-24">
                        <a href="https://www.twitch.tv/boyalone99" target="_blank" rel="noopener noreferrer" class="block h-full">
                            <img class="lazy w-full h-full object-cover" data-src="https://static-cdn.jtvnw.net/previews-ttv/live_user_boyalone99-1280x720.jpg" alt="Live stream preview of boyalone99 on Twitch">
                        </a>
                    </div>
                </div>
            </li>
            <li><a href="https://store.line.me/themeshop/product/2e590572-878f-484e-a4d6-6c6cff4a55fb/th" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">‡∏ò‡∏µ‡∏°‡πÑ‡∏•‡∏ô‡πå‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏µ (‡∏ò‡∏µ‡∏°‡∏°‡∏∑‡∏î)</span>
            </a></li>
            <li id="twitchregularlink"><a href="https://www.twitch.tv/boyalone99" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Twitch.tv</span>
            </a></li>
            <li><a href="https://www.fortnite.com/@boyalone99" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Fortnite Creator</span>
            </a></li>
            <li><a href="https://play.google.com/store/apps/details?id=com.wrblob" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
            </a></li>
            <li><a href="https://bpminecraft.com" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">BP Minecraft</span>
            </a></li>
            <li><a href="https://mccplog.pwisetthon.com" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Log ‡πÄ‡∏ã‡∏¥‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Minecraft</span>
            </a></li>
            <li>
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                    <a href="https://bussy.pwisetthon.com" class="flex-1">
                        <span class="text-blue-600 font-medium">Busy (‡πÄ‡∏ß‡πá‡∏ö‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô)</span>
                    </a>
                    <!-- Toggle button for card bottom section -->
                    <button id="toggleCardBottom" class="p-2 text-gray-600 hover:text-gray-800 transition-all duration-200 focus:outline-none ml-2">
                        <svg id="toggleIcon" class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            </li>
            
            <!-- Collapsible card bottom section -->
            <li id="cardBottomSection" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
                    <!-- Box 1 -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 min-h-[150px]">
                        <!-- Placeholder for box 1 -->
                    </div>
                    <!-- Box 2 -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 min-h-[150px]">
                        <!-- Placeholder for box 2 -->
                    </div>
                    <!-- Box 3 -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 min-h-[150px]">
                        <!-- Placeholder for box 3 -->
                    </div>
                </div>
            </li>
            
            <li><a href="https://send.pwisetthon.com" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Send (‡πÄ‡∏ß‡πá‡∏ö‡∏ù‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</span>
            </a></li>
            <li><a href="https://discordbot.pwisetthon.com" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Discord Bot</span>
            </a></li>
            <li><a href="https://www.battlemetrics.com/servers/palworld/33185507" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Free Palworld Server</span>
            </a></li>
            <li><a href="https://mkrm.pwisetthon.com" class="block p-4 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-200">
                <span class="text-blue-600 font-medium">Project ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Playlist ‡πÄ‡∏û‡∏•‡∏á</span>
            </a></li>
            <li>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div id="rainSensorBox" class="w-full">
                        <div class="block p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-800 font-medium">üåßÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡∏ô:</span>
                                <span id="rainStatus" class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="rainLastChanged">-</span><br>
                                ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà: <span id="rainBattery" class="text-gray-600">-</span>
                            </div>
                        </div>
                    </div>
                    <div id="lotteryBox" class="w-full">
                        <div class="block p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-800 font-medium">üéüÔ∏è ‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà:</span>
                                <span id="lotteryDate" class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πà‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 10 ‡∏õ‡∏µ:
                                <div id="lotteryTopNumbers" class="mt-2 text-gray-800 flex flex-wrap gap-2"></div>
                                <div id="lotteryError" class="hidden text-red-600 mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div id="githubActivityBox" class="w-full">
                        <div class="block p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-800 font-medium">üíª GitHub:</span>
                                <span id="githubActivityStatus" class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="githubLastActivity">-</span><br>
                                <span id="githubActivityDetail" class="text-gray-600">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ul>

        <!-- Steam Wishlist Section -->
        <div id="steamWishlistSection" class="mt-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Steam Wishlist</h2>
            <div id="steamWishlistLoading" class="text-gray-600">Loading wishlist...</div>
            <div id="steamWishlistError" class="hidden text-red-600"></div>
            <div id="steamWishlistContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.min.js"></script>

    <script defer>
        const lazyLoadInstance = new LazyLoad({
            elements_selector: ".lazy"
        });

        //fetch https://localpost.teamquadb.in.th/twitchstatus and if text is not "offline" then show the list item
        fetch('https://localpost.teamquadb.in.th/twitchstatus')
            .then(response => response.text())
            .then(data => {
                if (data != "offline") {
                    // remove class hidden from Twitch banner list item
                    document.getElementById("twitchbanneralert").classList.remove("hidden");
                    // hide the regular Twitch link when live banner is shown
                    document.getElementById("twitchregularlink").style.display = "none";
                }
            })
            .catch(error => {
                // Silently fail - banner remains hidden if API is unavailable
                console.error('Error fetching Twitch status:', error);
            });

        // Rain Sensor Functionality
        const RAIN_STATE_RAINING = 'on';
        
        function formatThaiTimeDifference(lastChangedTime) {
            const now = new Date();
            const lastChanged = new Date(lastChangedTime);
            const diffMs = now - lastChanged;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMinutes < 1) {
                return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            } else if (diffMinutes < 60) {
                return `${diffMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            } else if (diffHours < 24) {
                return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            } else {
                return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            }
        }

        async function fetchRainSensor() {
            try {
                const response = await fetch('https://anywhere.pwisetthon.com/http://192.168.31.227:1880/endpoint/rainsensor');
                if (!response.ok) {
                    throw new Error('Failed to fetch rain sensor data');
                }

                const data = await response.json();
                const rainStatusEl = document.getElementById('rainStatus');
                const rainLastChangedEl = document.getElementById('rainLastChanged');
                const rainBatteryEl = document.getElementById('rainBattery');

                // Check if status is "on" (raining) or anything else (not raining)
                if (data.state && data.state.toLowerCase() === RAIN_STATE_RAINING) {
                    if (rainStatusEl) {
                        rainStatusEl.textContent = '‡∏ù‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏Å';
                        rainStatusEl.className = 'text-blue-600 font-semibold';
                    }
                } else {
                    if (rainStatusEl) {
                        rainStatusEl.textContent = '‡πÑ‡∏°‡πà‡∏ï‡∏Å';
                        rainStatusEl.className = 'text-gray-600';
                    }
                }

                // Format and display last_changed time
                if (data.last_changed && rainLastChangedEl) {
                    rainLastChangedEl.textContent = formatThaiTimeDifference(data.last_changed);
                } else if (rainLastChangedEl) {
                    rainLastChangedEl.textContent = '-';
                }

                // Display battery percent (key: battery)
                if (rainBatteryEl) {
                    if (data.battery !== undefined && data.battery !== null && data.battery !== '') {
                        const raw = Number(data.battery);
                        if (isNaN(raw)) {
                            // show raw value if non-numeric
                            rainBatteryEl.textContent = String(data.battery);
                            rainBatteryEl.className = 'text-gray-600';
                        } else {
                            // normalize values like 0-1 to percentage
                            let percent = raw <= 1 ? Math.round(raw * 100) : Math.round(raw);
                            rainBatteryEl.textContent = `${percent}%`;
                            if (percent <= 20) {
                                rainBatteryEl.className = 'text-red-600 font-semibold';
                            } else if (percent <= 50) {
                                rainBatteryEl.className = 'text-yellow-600';
                            } else {
                                rainBatteryEl.className = 'text-gray-600';
                            }
                        }
                    } else {
                        rainBatteryEl.textContent = '-';
                        rainBatteryEl.className = 'text-gray-600';
                    }
                }

            } catch (error) {
                console.error('Error fetching rain sensor:', error);
                const rainStatusEl = document.getElementById('rainStatus');
                if (rainStatusEl) {
                    rainStatusEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                    rainStatusEl.className = 'text-red-600';
                }
                const rainBatteryEl = document.getElementById('rainBattery');
                if (rainBatteryEl) {
                    rainBatteryEl.textContent = '-';
                    rainBatteryEl.className = 'text-gray-600';
                }
            }
        }

        // Load rain sensor data when page loads
        fetchRainSensor();
        // Refresh rain sensor data every 5 minutes
        setInterval(fetchRainSensor, 5 * 60 * 1000);

        // Card Bottom Toggle Functionality
        const toggleButton = document.getElementById('toggleCardBottom');
        const toggleIcon = document.getElementById('toggleIcon');
        const cardBottomSection = document.getElementById('cardBottomSection');
        
        toggleButton.addEventListener('click', function() {
            // Toggle the hidden class
            cardBottomSection.classList.toggle('hidden');
            
            // Rotate the icon (180 degrees when expanded)
            if (cardBottomSection.classList.contains('hidden')) {
                toggleIcon.classList.remove('rotate-180');
            } else {
                toggleIcon.classList.add('rotate-180');
            }
        });

        // Steam Wishlist Functionality
        function createGameCard(appId) {
            const gameCard = document.createElement('div');
            gameCard.className = 'bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 overflow-hidden';
            gameCard.id = `game-card-${appId}`;
            
            // Create link element
            const link = document.createElement('a');
            link.href = `https://store.steampowered.com/app/${appId}`;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.className = 'block';
            
            // Create and add image (thumbnail)
            const img = document.createElement('img');
            img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/header.jpg`;
            img.alt = 'Loading...';
            img.className = 'w-full h-40 object-cover';
            img.onerror = function() { this.style.display = 'none'; };
            link.appendChild(img);
            
            // Create content div with game name and price
            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-3';
            
            // Create a flex container for title and price
            const titlePriceContainer = document.createElement('div');
            titlePriceContainer.className = 'flex items-center justify-between gap-2';
            
            // Create title with loading text
            const title = document.createElement('h3');
            title.className = 'font-medium text-gray-400 truncate flex-1';
            title.textContent = 'Loading...';
            title.id = `game-title-${appId}`;
            titlePriceContainer.appendChild(title);
            
            // Create price container with loading text
            const priceContainer = document.createElement('div');
            priceContainer.className = 'text-right flex-shrink-0';
            priceContainer.id = `game-price-${appId}`;
            
            const price = document.createElement('div');
            price.className = 'text-sm text-gray-400';
            price.textContent = 'Loading...';
            priceContainer.appendChild(price);
            
            titlePriceContainer.appendChild(priceContainer);
            contentDiv.appendChild(titlePriceContainer);
            
            link.appendChild(contentDiv);
            gameCard.appendChild(link);
            
            return gameCard;
        }

        async function updateGameDetails(appId, updateDOM = true) {
            try {
                // Fetch game details from Steam Store API
                const detailsResponse = await fetch(`https://anywhere.pwisetthon.com/https://store.steampowered.com/api/appdetails?appids=${appId}&cc=th`);
                
                if (!detailsResponse.ok) {
                    console.error(`HTTP error fetching app ${appId}: ${detailsResponse.status}`);
                    return null;
                }
                
                const detailsData = await detailsResponse.json();
                
                if (!detailsData[appId] || !detailsData[appId].success) {
                    return null;
                }
                
                const gameData = detailsData[appId].data;
                const gameName = gameData.name;
                
                // Get price information
                let priceText = 'Price not available';
                let hasDiscount = false;
                let originalPrice = '';
                let discountPercent = '';
                let discountValue = 0;
                
                if (gameData.is_free) {
                    priceText = 'Free to Play';
                } else if (gameData.price_overview) {
                    const priceOverview = gameData.price_overview;
                    priceText = priceOverview.final_formatted;
                    
                    if (priceOverview.discount_percent > 0) {
                        hasDiscount = true;
                        originalPrice = priceOverview.initial_formatted;
                        discountPercent = `-${priceOverview.discount_percent}%`;
                        discountValue = priceOverview.discount_percent;
                    }
                }
                
                // Update the card with actual data only if updateDOM is true
                if (updateDOM) {
                    const titleEl = document.getElementById(`game-title-${appId}`);
                    const priceContainerEl = document.getElementById(`game-price-${appId}`);
                    
                    if (titleEl) {
                        titleEl.textContent = gameName;
                        titleEl.className = 'font-medium text-gray-800 truncate flex-1';
                    }
                    
                    if (priceContainerEl) {
                        priceContainerEl.innerHTML = '';
                        
                        if (hasDiscount) {
                            // Original price (strikethrough)
                            const originalPriceEl = document.createElement('div');
                            originalPriceEl.className = 'text-xs text-gray-500 line-through';
                            originalPriceEl.textContent = originalPrice;
                            priceContainerEl.appendChild(originalPriceEl);
                            
                            // Discount percent and final price container
                            const discountContainer = document.createElement('div');
                            discountContainer.className = 'flex items-center gap-1';
                            
                            // Discount badge
                            const discountBadge = document.createElement('span');
                            discountBadge.className = 'text-xs bg-green-600 text-white px-1 rounded font-semibold';
                            discountBadge.textContent = discountPercent;
                            discountContainer.appendChild(discountBadge);
                            
                            // Final price
                            const finalPrice = document.createElement('span');
                            finalPrice.className = 'text-sm text-green-600 font-semibold';
                            finalPrice.textContent = priceText;
                            discountContainer.appendChild(finalPrice);
                            
                            priceContainerEl.appendChild(discountContainer);
                        } else {
                            // No discount, just show the price
                            const price = document.createElement('div');
                            price.className = 'text-sm text-blue-600 font-semibold';
                            price.textContent = priceText;
                            priceContainerEl.appendChild(price);
                        }
                    }
                }
                
                return { appId, discountValue }; // Return discount info for sorting
            } catch (error) {
                console.error(`Error fetching details for app ${appId}:`, error);
                return null;
            }
        }

        async function fetchSteamWishlist() {
            const apiKey = '22EEAC69A8668511FB364F212A0231B8';
            const steamId = '76561198069538631';
            const loadingEl = document.getElementById('steamWishlistLoading');
            const errorEl = document.getElementById('steamWishlistError');
            const contentEl = document.getElementById('steamWishlistContent');

            try {
                // Fetch wishlist data from Steam API
                const response = await fetch(`https://anywhere.pwisetthon.com/https://api.steampowered.com/IWishlistService/GetWishlist/v1/?key=${apiKey}&steamid=${steamId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch wishlist');
                }

                const data = await response.json();
                
                // Hide loading message
                loadingEl.style.display = 'none';

                // Check if wishlist is empty
                if (!data.response || !data.response.items || data.response.items.length === 0) {
                    contentEl.innerHTML = '<p class="text-gray-600">No games in wishlist</p>';
                    return;
                }

                // Phase 1: Quick display - show last 3 games from wishlist
                const totalGames = data.response.items.length;
                const initialGames = data.response.items.slice(Math.max(0, totalGames - 3));
                
                // Immediately show game cards with images and loading text
                initialGames.forEach(item => {
                    const gameCard = createGameCard(item.appid);
                    contentEl.appendChild(gameCard);
                });
                
                // Fetch details for initial 3 games and update their cards
                const initialDetailsPromises = initialGames.map(item => updateGameDetails(item.appid, true));
                await Promise.all(initialDetailsPromises);
                
                // Phase 2: Background process to find and display top 3 most discounted games
                // This runs asynchronously without blocking
                (async () => {
                    try {
                        // Fetch details for ALL games (without updating DOM)
                        const allGames = data.response.items;
                        const allDetailsPromises = allGames.map(item => updateGameDetails(item.appid, false));
                        const allDetails = await Promise.all(allDetailsPromises);
                        
                        // Filter valid results and sort by discount percentage (highest first)
                        const validDetails = allDetails
                            .filter(d => d !== null)
                            .sort((a, b) => b.discountValue - a.discountValue);
                        
                        // Get top 3 most discounted games
                        const top3Discounted = validDetails.slice(0, 3);
                        
                        // Check if top 3 discounted are different from initial display
                        const initialAppIds = initialGames.map(g => g.appid);
                        const top3AppIds = top3Discounted.map(d => d.appId);
                        
                        // Only update if different
                        const needsUpdate = !top3AppIds.every(id => initialAppIds.includes(id)) || 
                                          top3AppIds.length !== initialAppIds.length;
                        
                        if (needsUpdate && top3Discounted.length > 0) {
                            // Clear current display
                            contentEl.innerHTML = '';
                            
                            // Create and show cards for top 3 most discounted games
                            for (const detail of top3Discounted) {
                                const gameCard = createGameCard(detail.appId);
                                contentEl.appendChild(gameCard);
                                // Update with actual details
                                await updateGameDetails(detail.appId, true);
                            }
                        }
                    } catch (error) {
                        console.error('Error finding top discounted games:', error);
                        // If finding top games fails, keep showing the initial 3
                    }
                })();

            } catch (error) {
                console.error('Error fetching Steam wishlist:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Unable to load Steam wishlist. Please try again later.';
                errorEl.classList.remove('hidden');
            }
        }

        // Lottery: fetch last-10-year stats and next lottery date
        async function fetchLotteryData() {
            const proxyPrefix = 'https://anywhere.pwisetthon.com/';
            const base = 'https://lottsanook-cfworker.boy1556.workers.dev';
            const nextlotUrl = base + '/nextlot';
            const last10UrlBase = base + '/last10year?date=';
            const dateEl = document.getElementById('lotteryDate');
            const topEl = document.getElementById('lotteryTopNumbers');
            const errEl = document.getElementById('lotteryError');

            // Clear previous state
            if (dateEl) dateEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            if (topEl) topEl.innerHTML = '';
            if (errEl) { errEl.classList.add('hidden'); errEl.textContent = ''; }

            let queryDate = '01102568'; // fallback
            try {
                // First fetch the next lottery date
                const nresp = await fetch(proxyPrefix + nextlotUrl);
                if (nresp.ok) {
                    const ndata = await nresp.json();
                    // prefer explicit `date` field
                    if (ndata && (ndata.date || ndata.nextDate || ndata.next)) {
                        queryDate = ndata.date || ndata.nextDate || ndata.next;
                    } else {
                        // try to find a date-like string
                        if (typeof ndata === 'string') queryDate = ndata;
                        else if (ndata && typeof ndata === 'object') {
                            for (const k of Object.keys(ndata)) {
                                if (/date/i.test(k) && ndata[k]) { queryDate = ndata[k]; break; }
                            }
                        }
                    }
                } else {
                    console.warn('nextlot fetch failed, using fallback date', nresp.status);
                }
            } catch (e) {
                console.warn('Error fetching nextlot, using fallback date', e);
            }

            // Now fetch last10year using the determined date
            try {
                const resp = await fetch(proxyPrefix + last10UrlBase + encodeURIComponent(String(queryDate)));
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                // Helper: find a date-like field in various possible keys
                function findDate(obj) {
                    if (!obj || typeof obj !== 'object') return null;
                    const candidates = ['nextDate','next_draw','next','date','draw_date','nextDateStr'];
                    for (const k of candidates) {
                        if (k in obj && obj[k]) return obj[k];
                    }
                    // search shallowly
                    for (const k in obj) {
                        if (typeof obj[k] === 'string' && /\d{2,4}[-\/]?\d{1,2}[-\/]?\d{1,2}/.test(obj[k])) return obj[k];
                    }
                    return null;
                }

                // Helper: extract top numbers array from response
                function extractTopNumbers(obj) {
                    if (!obj) return null;
                    // if top-level is array
                    if (Array.isArray(obj)) return obj;
                    // common candidate keys
                    const keys = ['most','top','topNumbers','data','result','stats','most_number'];
                    for (const k of keys) {
                        if (k in obj && obj[k]) return obj[k];
                    }
                    // if object contains numeric keys mapping to counts
                    const arr = [];
                    for (const k in obj) {
                        const v = obj[k];
                        if ((typeof v === 'number' || typeof v === 'string') && /^\d+$/.test(k)) {
                            arr.push({ number: k, count: Number(v) });
                        }
                    }
                    if (arr.length) return arr;
                    return null;
                }

                // determine displayed date: prefer the date we queried (from nextlot) but fall back to response
                let displayedDate = queryDate;
                const respDate = findDate(data) || findDate(data.response) || findDate(data.data) || null;
                if (!displayedDate && respDate) displayedDate = respDate;
                if (respDate && typeof respDate === 'object' && respDate.date) {
                    if (!displayedDate) displayedDate = respDate.date;
                }

                // find top numbers
                let tops = extractTopNumbers(data) || extractTopNumbers(data.response) || extractTopNumbers(data.data) || [];

                // Normalize tops to array of {number, value/count/order}
                let norm = [];
                if (Array.isArray(tops)) {
                    // array could be primitives or objects
                    tops.forEach(item => {
                        if (!item) return;
                        if (typeof item === 'string' || typeof item === 'number') {
                            norm.push({ number: String(item), count: 0 });
                        } else if (typeof item === 'object') {
                            // common fields
                            const num = item.number || item.num || item.n || item.code || item.key || item.value || item.label;
                            const count = item.count || item.value || item.freq || item.frequency || item.times || item.order || item.score || 0;
                            if (num !== undefined) norm.push({ number: String(num), count: Number(count || 0) });
                            else {
                                // try first prop as number
                                const firstKey = Object.keys(item)[0];
                                norm.push({ number: String(item[firstKey]), count: Number(Object.values(item)[1] || 0) });
                            }
                        }
                    });
                } else if (typeof tops === 'object') {
                    for (const k in tops) {
                        norm.push({ number: String(k), count: Number(tops[k] || 0) });
                    }
                }

                // If normalization failed and data has a 'most' object mapping
                if (!norm.length && typeof data === 'object') {
                    const candidate = data.most || data.top || data.topNumbers;
                    if (candidate && typeof candidate === 'object') {
                        for (const k in candidate) norm.push({ number: String(k), count: Number(candidate[k] || 0) });
                    }
                }

                // sort by count/value descending
                norm.sort((a, b) => (b.count || 0) - (a.count || 0));

                // Update UI
                if (dateEl) dateEl.textContent = displayedDate ? String(displayedDate) : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
                if (topEl) {
                    if (!norm.length) {
                        topEl.innerHTML = '<div class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πà‡∏ô</div>';
                    } else {
                        // show top items (limit to 10)
                        const show = norm.slice(0, 10);
                        show.forEach(item => {
                            const badge = document.createElement('div');
                            badge.className = 'px-2 py-1 bg-gray-100 rounded text-sm border text-gray-800';
                            badge.textContent = `${item.number} (${item.count})`;
                            topEl.appendChild(badge);
                        });
                    }
                }
            } catch (err) {
                console.error('Error fetching lottery data:', err);
                if (errEl) { errEl.classList.remove('hidden'); errEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≠‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ'; }
                if (dateEl) dateEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
            }
        }

    // GitHub Activity Functionality
    async function fetchGithubActivity() {
        const username = 'boyphongsakorn';
        const statusEl = document.getElementById('githubActivityStatus');
        const lastActivityEl = document.getElementById('githubLastActivity');
        const detailEl = document.getElementById('githubActivityDetail');

        try {
            const response = await fetch(`https://api.github.com/users/${username}/events/public`);
            if (!response.ok) {
                throw new Error('Failed to fetch GitHub activity');
            }

            const events = await response.json();
            
            if (!events || events.length === 0) {
                if (statusEl) statusEl.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                if (lastActivityEl) lastActivityEl.textContent = '-';
                if (detailEl) detailEl.textContent = '-';
                return;
            }

            // Get the most recent event
            const latestEvent = events[0];
            const eventDate = new Date(latestEvent.created_at);
            
            // Update status
            if (statusEl) {
                statusEl.textContent = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
                statusEl.className = 'text-green-600 font-semibold';
            }

            // Update last activity time
            if (lastActivityEl) {
                lastActivityEl.textContent = formatThaiTimeDifference(latestEvent.created_at);
            }

            // Format event detail
            let eventDetail = '';
            switch (latestEvent.type) {
                case 'PushEvent':
                    const commits = latestEvent.payload.commits ? latestEvent.payload.commits.length : 0;
                    eventDetail = `Push ${commits} commit(s) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${latestEvent.repo.name}`;
                    break;
                case 'CreateEvent':
                    eventDetail = `‡∏™‡∏£‡πâ‡∏≤‡∏á ${latestEvent.payload.ref_type} ‡πÉ‡∏ô ${latestEvent.repo.name}`;
                    break;
                case 'DeleteEvent':
                    eventDetail = `‡∏•‡∏ö ${latestEvent.payload.ref_type} ‡πÉ‡∏ô ${latestEvent.repo.name}`;
                    break;
                case 'IssuesEvent':
                    eventDetail = `${latestEvent.payload.action} issue ‡πÉ‡∏ô ${latestEvent.repo.name}`;
                    break;
                case 'PullRequestEvent':
                    eventDetail = `${latestEvent.payload.action} PR ‡πÉ‡∏ô ${latestEvent.repo.name}`;
                    break;
                case 'WatchEvent':
                    eventDetail = `Star ${latestEvent.repo.name}`;
                    break;
                case 'ForkEvent':
                    eventDetail = `Fork ${latestEvent.repo.name}`;
                    break;
                default:
                    eventDetail = `${latestEvent.type.replace('Event', '')} ‡πÉ‡∏ô ${latestEvent.repo.name}`;
            }

            if (detailEl) {
                detailEl.textContent = eventDetail;
                detailEl.className = 'text-gray-800';
            }

        } catch (error) {
            console.error('Error fetching GitHub activity:', error);
            if (statusEl) {
                statusEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                statusEl.className = 'text-red-600';
            }
            if (lastActivityEl) lastActivityEl.textContent = '-';
            if (detailEl) detailEl.textContent = '-';
        }
    }

    // Load Steam wishlist when page loads
    fetchSteamWishlist();

    // Load lottery data one time when page loads
    fetchLotteryData();

    // Load GitHub activity when page loads
    fetchGithubActivity();
    </script>
</body>
</html>
